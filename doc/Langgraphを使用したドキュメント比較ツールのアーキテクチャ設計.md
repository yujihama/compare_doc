# Langgraphを使用したドキュメント比較ツールのアーキテクチャ設計

## 1. 全体アーキテクチャ

Langgraphを使用して2つのドキュメント間の比較を行うツールの全体アーキテクチャを以下に示します。このツールは、既にチャンク化された2つのドキュメントを入力とし、それらの間の差分（追加、削除、変更）を特定して表形式のマークダウンで出力します。

```
┌─────────────────────────────────────────────────────────────────┐
│                      ドキュメント比較システム                      │
│                                                                 │
│  ┌─────────────┐    ┌─────────────────────────────────────┐    │
│  │  ドキュメントA │    │          Langgraphエンジン          │    │
│  │ (チャンクリスト)│───▶│                                   │    │
│  └─────────────┘    │  ┌───────────────────────────────┐  │    │
│                     │  │        Reactエージェント        │  │    │
│  ┌─────────────┐    │  │                               │  │    │
│  │  ドキュメントB │    │  │  ┌─────────────────────────┐  │  │    │
│  │ (チャンクリスト)│───▶│  │  │      ツールセット       │  │  │    │
│  └─────────────┘    │  │  │                         │  │  │    │
│                     │  │  │ ・文字列検索ツール        │  │  │    │
│                     │  │  │ ・ベクトル類似度検索ツール │  │  │    │
│                     │  │  │ ・文脈取得ツール         │  │  │    │
│                     │  │  │ ・前後チャンク取得ツール  │  │  │    │
│                     │  │  └─────────────────────────┘  │  │    │
│                     │  │                               │  │    │
│                     │  └───────────────────────────────┘  │    │
│                     │                                     │    │
│                     └─────────────────────────────────────┘    │
│                                      │                         │
│                                      ▼                         │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                    比較結果（マークダウン表）               │  │
│  │                                                          │  │
│  │  | 項目 | ドキュメントA | ドキュメントB | 変更タイプ |     │  │
│  │  |------|-------------|-------------|-----------|     │  │
│  │  | ...  | ...         | ...         | 追加/削除/変更 |  │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

## 2. コンポーネント詳細

### 2.1 入力データ構造

```python
# 入力データ構造の例
document_a = [
    {"id": "A1", "content": "チャンク1の内容", "metadata": {...}},
    {"id": "A2", "content": "チャンク2の内容", "metadata": {...}},
    # ...
]

document_b = [
    {"id": "B1", "content": "チャンク1の内容", "metadata": {...}},
    {"id": "B2", "content": "チャンク2の内容", "metadata": {...}},
    # ...
]
```

### 2.2 ツールセット

Reactエージェントが使用する5つのツールの詳細設計：

#### ツール1: 文字列検索ツール
- 機能: 指定された語句で文字列検索した結果を取得する
- 入力: 検索語句、検索対象ドキュメント
- 出力: マッチしたチャンクのリスト

#### ツール2: ベクトル類似度検索ツール
- 機能: 指定された語句・文章とベクトル類似度が高いチャンクを取得する
- 入力: クエリテキスト、検索対象ドキュメント、類似度閾値、最大結果数
- 出力: 類似度スコア付きのチャンクリスト
- 使用モデル: OpenAI large埋め込みモデル

#### ツール3: 比較元チャンクの文脈取得ツール
- 機能: 指定されたチャンクの文脈情報を取得する
- 入力: チャンクID、ドキュメント
- 出力: チャンクの詳細情報と関連メタデータ

#### ツール4: 比較先チャンクの文脈取得ツール
- 機能: 指定されたチャンクの文脈情報を取得する
- 入力: チャンクID、ドキュメント
- 出力: チャンクの詳細情報と関連メタデータ

#### ツール5: 前後チャンク取得ツール
- 機能: 特定のチャンクの前、または後に続くチャンクを指定された数だけ取得
- 入力: チャンクID、ドキュメント、取得方向（前/後）、取得数
- 出力: 指定された数の前後チャンクリスト

### 2.3 状態管理

Langgraphでの状態管理設計：

```python
# 状態の型定義
class ComparisonState(TypedDict):
    # 入力ドキュメント
    document_a: List[Dict]
    document_b: List[Dict]
    
    # 現在処理中のチャンク
    current_chunk_a: Optional[Dict]
    
    # 比較結果の蓄積
    comparison_results: List[Dict]
    
    # 処理済みチャンクの追跡
    processed_chunks_a: List[str]
    
    # エージェントの思考ログ
    agent_thoughts: List[str]
    
    # 現在のステップ
    current_step: str
```

### 2.4 データフロー

1. 初期化: 2つのドキュメントをシステムに入力
2. チャンク処理: ドキュメントAの各チャンクを順番に処理
3. 比較処理: 各チャンクについて、Reactエージェントが自律的にツールを使用して比較を実行
4. 結果集約: 比較結果を蓄積し、最終的に表形式のマークダウンに変換
5. 出力: 比較結果を表形式で出力

## 3. Langgraphノード設計

```python
# Langgraphのノード設計
nodes = {
    "initialize": initialize_comparison,
    "select_next_chunk": select_next_chunk_from_doc_a,
    "react_agent": react_agent_node,
    "process_comparison_results": process_comparison_results,
    "format_output": format_output_as_markdown_table,
}

# エッジ設計
edges = {
    "initialize": "select_next_chunk",
    "select_next_chunk": {
        "has_more_chunks": "react_agent",
        "no_more_chunks": "format_output"
    },
    "react_agent": "process_comparison_results",
    "process_comparison_results": "select_next_chunk",
    "format_output": END
}
```

## 4. 状態遷移図

```
┌─────────────┐
│  初期化     │
└─────┬───────┘
      │
      ▼
┌─────────────────────┐     ┌─────────────┐
│  次のチャンクを選択  │────▶│  出力整形   │
└─────────┬───────────┘     └─────────────┘
          │                       ▲
          │                       │
          ▼                       │
┌─────────────────────┐          │
│  Reactエージェント   │          │
└─────────┬───────────┘          │
          │                       │
          ▼                       │
┌─────────────────────┐          │
│  比較結果の処理     │──────────┘
└─────────────────────┘
```
