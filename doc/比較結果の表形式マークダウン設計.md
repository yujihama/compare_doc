# 比較結果の表形式マークダウン設計

## 1. 表のフォーマット設計

比較結果を明確に表示するための表形式マークダウンを設計します。この表は、2つのドキュメント間の差分（追加、削除、変更）を視覚的に分かりやすく表現することを目的としています。

### 1.1 基本テーブル構造

```markdown
| No. | 変更タイプ | ドキュメントA | ドキュメントB | 詳細 |
|-----|------------|--------------|--------------|------|
| 1   | 変更       | 原文テキスト  | 変更後テキスト | 変更内容の詳細説明 |
| 2   | 追加       | -            | 追加されたテキスト | 追加された内容の説明 |
| 3   | 削除       | 削除されたテキスト | - | 削除された内容の説明 |
```

### 1.2 各列の説明

1. **No.**: 比較結果の通し番号
2. **変更タイプ**: 「追加」「削除」「変更」「一致」のいずれか
3. **ドキュメントA**: 比較元ドキュメントのチャンク内容
4. **ドキュメントB**: 比較先ドキュメントのチャンク内容
5. **詳細**: 変更内容の詳細説明

### 1.3 拡張テーブル構造（オプション）

より詳細な情報を含める場合は、以下の拡張構造も検討できます：

```markdown
| No. | 変更タイプ | チャンクID(A) | チャンクID(B) | ドキュメントA | ドキュメントB | 類似度 | 詳細 |
|-----|------------|--------------|--------------|--------------|--------------|--------|------|
| 1   | 変更       | A5           | B7           | 原文テキスト  | 変更後テキスト | 0.85   | 変更内容の詳細説明 |
```

## 2. 差分表示方法の設計

### 2.1 変更タイプの視覚的表現

変更タイプを視覚的に区別するために、以下のような表現方法を採用します：

```markdown
| No. | 変更タイプ | ドキュメントA | ドキュメントB | 詳細 |
|-----|------------|--------------|--------------|------|
| 1   | 🔄 変更    | 原文テキスト  | 変更後テキスト | 変更内容の詳細説明 |
| 2   | ➕ 追加    | -            | 追加されたテキスト | 追加された内容の説明 |
| 3   | ❌ 削除    | 削除されたテキスト | - | 削除された内容の説明 |
| 4   | ✓ 一致     | 一致テキスト  | 一致テキスト  | 完全一致 |
```

### 2.2 テキスト差分のハイライト

変更されたテキスト部分をより明確に示すために、詳細列で以下のようなマークダウン表現を使用します：

```markdown
| No. | 変更タイプ | ドキュメントA | ドキュメントB | 詳細 |
|-----|------------|--------------|--------------|------|
| 1   | 🔄 変更    | プロジェクトの目標は、顧客満足度を**20%**向上させることです。 | プロジェクトの目標は、顧客満足度を**25%**向上させることです。 | **変更**: 目標値が20%から25%に変更されました |
```

### 2.3 詳細な差分表示（複雑な変更の場合）

複雑な変更の場合、詳細列に箇条書きで変更点を列挙します：

```markdown
| No. | 変更タイプ | ドキュメントA | ドキュメントB | 詳細 |
|-----|------------|--------------|--------------|------|
| 1   | 🔄 変更    | プロジェクトの目標は、顧客満足度を20%向上させることです。これを達成するために、以下の3つの施策を実施します。 | プロジェクトの目標は、顧客満足度を25%向上させることです。これを達成するために、以下の4つの施策を実施します。 | **変更点**:<br>- 顧客満足度の目標が「20%向上」から「25%向上」に変更<br>- 施策が3つから4つに増加<br>- 新たに「オンラインサポートの強化」が追加 |
```

## 3. 実装例

以下は、比較結果を表形式マークダウンに変換する実装例です：

```python
def format_comparison_results_as_markdown_table(comparison_results):
    """
    比較結果を表形式のマークダウンに変換する
    
    Args:
        comparison_results: 比較結果のリスト
        
    Returns:
        表形式のマークダウン文字列
    """
    # テーブルヘッダー
    markdown = "# ドキュメント比較結果\n\n"
    markdown += "## 概要\n\n"
    
    # 統計情報
    total = len(comparison_results)
    changes = sum(1 for r in comparison_results if r["type"] == "変更")
    additions = sum(1 for r in comparison_results if r["type"] == "追加")
    deletions = sum(1 for r in comparison_results if r["type"] == "削除")
    matches = sum(1 for r in comparison_results if r["type"] == "一致")
    
    markdown += f"- 総チャンク数: {total}\n"
    markdown += f"- 変更: {changes}\n"
    markdown += f"- 追加: {additions}\n"
    markdown += f"- 削除: {deletions}\n"
    markdown += f"- 一致: {matches}\n\n"
    
    # 詳細テーブル
    markdown += "## 詳細比較結果\n\n"
    markdown += "| No. | 変更タイプ | ドキュメントA | ドキュメントB | 詳細 |\n"
    markdown += "|-----|------------|--------------|--------------|------|\n"
    
    for i, result in enumerate(comparison_results, 1):
        # 変更タイプのアイコン
        type_icon = {
            "変更": "🔄 変更",
            "追加": "➕ 追加",
            "削除": "❌ 削除",
            "一致": "✓ 一致"
        }.get(result["type"], result["type"])
        
        # ドキュメントAの内容
        doc_a_content = result.get("chunk_a", {}).get("content", "-") if result["type"] != "追加" else "-"
        if len(doc_a_content) > 100:
            doc_a_content = doc_a_content[:97] + "..."
            
        # ドキュメントBの内容
        doc_b_content = result.get("chunk_b", {}).get("content", "-") if result["type"] != "削除" else "-"
        if len(doc_b_content) > 100:
            doc_b_content = doc_b_content[:97] + "..."
        
        # 詳細情報
        details = result.get("details", "")
        
        # 行の追加
        markdown += f"| {i} | {type_icon} | {doc_a_content} | {doc_b_content} | {details} |\n"
    
    return markdown
```

## 4. 出力例

以下は、実際の比較結果の出力例です：

```markdown
# ドキュメント比較結果

## 概要

- 総チャンク数: 15
- 変更: 5
- 追加: 3
- 削除: 2
- 一致: 5

## 詳細比較結果

| No. | 変更タイプ | ドキュメントA | ドキュメントB | 詳細 |
|-----|------------|--------------|--------------|------|
| 1   | ✓ 一致     | このドキュメントは、プロジェクト計画書のドラフトです。 | このドキュメントは、プロジェクト計画書のドラフトです。 | 完全一致 |
| 2   | 🔄 変更    | プロジェクト名：システム刷新プロジェクト | プロジェクト名：システム刷新プロジェクト2023 | **変更**: プロジェクト名に年号「2023」が追加されました |
| 3   | 🔄 変更    | プロジェクトの目標は、顧客満足度を20%向上させることです。これを達成するために、以下の3つの施策を実施します。 | プロジェクトの目標は、顧客満足度を25%向上させることです。これを達成するために、以下の4つの施策を実施します。 | **変更点**:<br>- 顧客満足度の目標が「20%向上」から「25%向上」に変更<br>- 施策が3つから4つに増加<br>- 新たに「オンラインサポートの強化」が追加 |
| 4   | ➕ 追加    | - | 本プロジェクトは、経営陣の承認を得て2023年4月1日に開始されました。 | 新たにプロジェクト開始日に関する情報が追加されました |
| 5   | ❌ 削除    | 予算は500万円を上限とします。 | - | 予算に関する記述が削除されました |
```

## 5. 表示上の考慮事項

### 5.1 長いテキストの扱い

チャンク内容が長い場合、表の可読性を保つために以下の方法を採用します：

1. テキストを一定長（例：100文字）で切り詰め、末尾に「...」を追加
2. 詳細な内容は別途展開可能な形式で提供（例：折りたたみセクション）

### 5.2 マークダウンレンダリングの互換性

異なるマークダウンレンダラーでの表示互換性を考慮し、以下の点に注意します：

1. 複雑なマークダウン記法は避け、基本的な記法のみ使用
2. 絵文字は一般的にサポートされているものを使用
3. テーブル内での改行は `<br>` タグを使用

### 5.3 差分の視認性向上

差分の視認性を向上させるために、以下の工夫を行います：

1. 変更された部分は太字（`**変更テキスト**`）でハイライト
2. 追加された内容は緑色、削除された内容は赤色で表示（HTML対応の場合）
3. 変更タイプごとに異なるアイコンを使用して視覚的区別を強化
